{% extends "base.html" %}

{% block title %}التصنيف - YOLOv8 Vision Lab{% endblock %}

{% block page_title %}التصنيف التلقائي{% endblock %}
{% block page_subtitle %}تصنيف الصور وإنشاء بيانات التدريب{% endblock %}

{% block content %}
<!-- Annotation Tools Section -->
<div class="row animate-fade-in">
    <!-- Tools Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="glass" style="padding: 1.5rem; border-radius: 24px;">
            <h4 class="text-gradient mb-3">أدوات التصنيف</h4>
            
            <!-- Class Management -->
            <div class="mb-4">
                <label class="form-label text-secondary">الفئات</label>
                <div id="classList" class="mb-3">
                    <!-- Classes will be loaded here -->
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="newClassName" placeholder="إضافة فئة جديدة" value="palm tree" style="background: var(--bg-glass-hover); border: 1px solid var(--border-glass); color: var(--text-primary);">
                    <button class="action-btn" type="button" onclick="addClass()" style="padding: 0.5rem 1rem;">
                        <i data-lucide="plus"></i>
                    </button>
                </div>
            </div>

            <!-- Auto Tree Detection -->
            <div class="mb-4">
                <label class="form-label text-secondary">الكشف التلقائي</label>
                <div class="d-grid gap-2">
                    <button class="action-btn" onclick="uploadImagesForAutoDetection()">
                        <i data-lucide="upload"></i>
                        رفع الصور
                    </button>
                    <button class="action-btn secondary" onclick="startAutoDetectionAndSave()" id="autoDetectBtn" disabled>
                        <i data-lucide="zap"></i>
                        بدء الكشف والحفظ التلقائي
                    </button>
                </div>
                <small class="text-muted">رفع صور متعددة للكشف التلقائي وحفظها في dataset</small>
            </div>



            <!-- Active Tool -->
            <div class="mb-4">
                <label class="form-label text-secondary">الأداة النشطة</label>
                <div class="d-grid gap-2">
                    <button type="button" class="action-btn active" id="drawTool" onclick="setTool('draw')">
                        <i data-lucide="square"></i>
                        رسم صندوق
                    </button>
                    <button type="button" class="action-btn secondary" id="selectTool" onclick="setTool('select')">
                        <i data-lucide="mouse-pointer"></i>
                        تحديد
                    </button>
                    <button type="button" class="action-btn secondary" id="deleteTool" onclick="setTool('delete')">
                        <i data-lucide="trash-2"></i>
                        حذف
                    </button>
                </div>
            </div>

            <!-- Annotation Controls -->
            <div class="mb-4">
                <label class="form-label text-secondary">التحكم</label>
                <div class="d-grid gap-2">
                    <button class="action-btn" onclick="saveAnnotations()">
                        <i data-lucide="save"></i>
                        حفظ
                    </button>
                    <button class="action-btn secondary" onclick="undoLast()">
                        <i data-lucide="undo"></i>
                        تراجع
                    </button>
                    <button class="action-btn secondary" onclick="redoLast()">
                        <i data-lucide="redo"></i>
                        إعادة
                    </button>
                    <button class="action-btn secondary" onclick="clearAll()">
                        <i data-lucide="trash"></i>
                        مسح الكل
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="mb-4">
                <label class="form-label text-secondary">الإحصائيات</label>
                <div class="stats-grid" style="display: grid; gap: 0.5rem;">
                    <div class="stat-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-glass-hover); border-radius: 8px;">
                        <span class="text-muted">الصناديق:</span>
                        <span class="fw-bold" id="boxCount">0</span>
                    </div>
                    <div class="stat-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-glass-hover); border-radius: 8px;">
                        <span class="text-muted">الصورة:</span>
                        <span class="fw-bold" id="currentImageIndex">0</span>/<span id="totalImages">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Canvas -->
    <div class="col-lg-6 mb-4">
        <div class="glass" style="padding: 1.5rem; border-radius: 24px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-gradient mb-0">منطقة التصنيف</h4>
                <div class="btn-group" role="group">
                    <button class="action-btn secondary" onclick="zoomOut()" style="padding: 0.5rem;">
                        <i data-lucide="zoom-out"></i>
                    </button>
                    <button class="action-btn secondary" onclick="resetZoom()" style="padding: 0.5rem;">
                        <i data-lucide="maximize-2"></i>
                    </button>
                    <button class="action-btn secondary" onclick="zoomIn()" style="padding: 0.5rem;">
                        <i data-lucide="zoom-in"></i>
                    </button>
                </div>
            </div>
            
            <div id="canvasContainer" style="position: relative; overflow: auto; max-height: 600px; border-radius: 16px; background: var(--bg-secondary);">
                <canvas id="annotationCanvas" style="border-radius: 16px; cursor: crosshair;"></canvas>
            </div>
        </div>

        <!-- Navigation -->
        <div class="glass" style="padding: 1.5rem; border-radius: 24px; margin-top: 1rem;">
            <div class="d-flex justify-content-between align-items-center">
                <button class="action-btn secondary" onclick="previousImage()" id="prevBtn">
                    <i data-lucide="chevron-left"></i>
                    السابق
                </button>
                <div>
                    <input type="file" class="form-control" id="imageInput" accept="image/*" multiple onchange="loadImages(this.files)" style="background: var(--bg-glass-hover); border: 1px solid var(--border-glass); color: var(--text-primary);">
                </div>
                <button class="action-btn secondary" onclick="nextImage()" id="nextBtn">
                    التالي
                    <i data-lucide="chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3 mb-4">
        <!-- Image List -->
        <div class="glass" style="padding: 1.5rem; border-radius: 24px; margin-bottom: 1rem;">
            <h4 class="text-gradient mb-3">قائمة الصور</h4>
            <div id="imageList" style="max-height: 300px; overflow-y: auto;">
                <!-- Image thumbnails will be loaded here -->
            </div>
        </div>

        <!-- Selected Box Properties -->
        <div class="glass" style="padding: 1.5rem; border-radius: 24px; margin-bottom: 1rem;">
            <h4 class="text-gradient mb-3">خصائص الصندوق</h4>
            <div id="boxProperties">
                <p class="text-muted">حدد صندوق إحاطة لتحرير الخصائص</p>
            </div>
        </div>

        <!-- Export Options -->
        <div class="glass" style="padding: 1.5rem; border-radius: 24px;">
            <h4 class="text-gradient mb-3">تصدير البيانات</h4>
            <div class="d-grid gap-2">
                <button class="action-btn" onclick="exportYOLO()">
                    <i data-lucide="download"></i>
                    تصدير YOLO
                </button>
                <button class="action-btn secondary" onclick="exportCOCO()">
                    <i data-lucide="download"></i>
                    تصدير COCO
                </button>
                <button class="action-btn secondary" onclick="generateDataset()">
                    <i data-lucide="folder"></i>
                    إنشاء Dataset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auto Detection Progress (Hidden by default) -->
<div id="autoDetectionProgress" style="display: none;"></div>

<!-- Annotation JavaScript -->
<script>
class AnnotationTool {
    constructor() {
        this.canvas = document.getElementById('annotationCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.images = [];
        this.currentImageIndex = 0;
        this.currentImage = null;
        this.annotations = [];
        this.classes = ['palm tree'];
        this.activeClass = 0;
        this.tool = 'draw';
        this.isDrawing = false;
        this.startX = 0;
        this.startY = 0;
        this.scale = 1;
        this.selectedBox = null;
        this.undoStack = [];
        this.redoStack = [];
        
        // Auto detection variables
        this.uploadedImages = [];
        this.isAutoDetecting = false;
        
        this.initializeEventListeners();
        this.loadClasses();
    }
    
    startAutoDetection() {
        if (this.uploadedImages.length === 0) {
            alert('لا توجد صور مرفوعة للكشف التلقائي!');
            return;
        }
        
        this.isAutoDetecting = true;
        
        // Show progress
        this.showAutoDetectionProgress();
        
        // Process images in batches
        this.processImagesForAutoDetection();
    }
    
    showAutoDetectionProgress() {
        const progressDiv = document.createElement('div');
        progressDiv.id = 'autoDetectionProgress';
        progressDiv.className = 'glass';
        progressDiv.style.cssText = 'padding: 1.5rem; border-radius: 24px; margin-bottom: 1rem; display: block;';
        progressDiv.innerHTML = `
            <div class="d-flex align-items-center mb-3">
                <div class="spinner-border spinner-border-sm me-2" role="status" style="color: var(--primary-purple);"></div>
                <strong class="text-gradient">الكشف التلقائي جاري...</strong>
            </div>
            <div class="progress-container">
                <div class="progress-label">
                    <span>التقدم</span>
                    <span id="autoDetectionProgressBar">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="autoDetectionProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <small class="text-muted">معالجة الصور للكشف عن أشجار النخيل...</small>
        `;
        
        // Insert at the top of the content
        const contentArea = document.querySelector('.content-area');
        contentArea.insertBefore(progressDiv, contentArea.firstChild);
    }
    
    async processImagesForAutoDetection() {
        const totalImages = this.uploadedImages.length;
        let processedImages = 0;
        
        for (let i = 0; i < totalImages; i++) {
            if (!this.isAutoDetecting) break; // Check if stopped
            
            const file = this.uploadedImages[i];
            
            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('image', file);
                
                // Send to server for auto detection
                const response = await fetch('/api/auto_detect_trees', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    processedImages++;
                    
                    // Update progress
                    this.updateAutoDetectionProgress(processedImages, totalImages);
                    
                    // Show result
                    this.showAutoDetectionResult(file.name, result);
                    
    startAutoDetectionForImage(imageData, callback) {
        // Simulate auto detection for a single image
        // In a real implementation, this would call the actual detection API
        
        // Create FormData for upload
        const formData = new FormData();
        formData.append('image', imageData);
        
        // Send to server for auto detection
        fetch('/api/auto_detect_trees', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success && result.trees_detected > 0) {
                // Convert detections to annotation format
                const detections = this.convertDetectionsToAnnotations(result);
                callback(detections);
            } else {
                // No trees detected, return empty array
                callback([]);
            }
        })
        .catch(error => {
            console.error('Error in auto detection:', error);
            // Return empty array on error
            callback([]);
        });
    }
    
    convertDetectionsToAnnotations(detectionResult) {
        // This is a placeholder - in real implementation, you'd parse the actual detection results
        // For now, return mock annotations
        const mockDetections = [];
        const numDetections = Math.min(detectionResult.trees_detected, 5); // Max 5 detections
        
        for (let i = 0; i < numDetections; i++) {
            mockDetections.push({
                x: Math.random() * 80 + 10, // Random position 10-90%
                y: Math.random() * 80 + 10,
                width: Math.random() * 20 + 10, // Random size 10-30%
                height: Math.random() * 30 + 20, // Random height 20-50%
                class: 'palm_tree'
            });
        }
        
        return mockDetections;
    }
                } else {
                    console.error(`Failed to process ${file.name}`);
                }
                
            } catch (error) {
                console.error(`Error processing ${file.name}:`, error);
            }
        }
        
        // Complete auto detection
        this.completeAutoDetection(processedImages, totalImages);
    }
    
    updateAutoDetectionProgress(processed, total) {
        const progressBar = document.getElementById('autoDetectionProgressBar');
        const progressFill = document.getElementById('autoDetectionProgressFill');
        if (progressBar && progressFill) {
            const percentage = (processed / total) * 100;
            progressBar.textContent = `${processed}/${total}`;
            progressFill.style.width = `${percentage}%`;
        }
    }
    
    showAutoDetectionResult(filename, result) {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'glass';
        resultDiv.style.cssText = 'padding: 1rem; border-radius: 16px; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;';
        resultDiv.innerHTML = `
            <i data-lucide="tree" style="color: var(--accent-cyan);"></i>
            <strong>${filename}</strong>: تم اكتشاف ${result.trees_detected} شجرة نخيل
        `;
        
        // Insert after progress
        const progressDiv = document.getElementById('autoDetectionProgress');
        if (progressDiv) {
            progressDiv.appendChild(resultDiv);
        }
    }
    
    completeAutoDetection(processed, total) {
        this.isAutoDetecting = false;
        
        // Update progress div
        const progressDiv = document.getElementById('autoDetectionProgress');
        if (progressDiv) {
            progressDiv.innerHTML = `
                <div class="text-center">
                    <i data-lucide="check-circle" style="width: 48px; height: 48px; color: var(--accent-cyan); margin-bottom: 1rem;"></i>
                    <h4 class="text-gradient">اكتمل الكشف التلقائي!</h4>
                    <p class="text-muted">تمت معالجة ${processed} من ${total} صورة. تم حفظ النتائج في مجلد augmented_data.</p>
                    <button class="action-btn" onclick="downloadAutoDetectionResults()">
                        <i data-lucide="download"></i>
                        تحميل النتائج
                    </button>
                </div>
            `;
        }
        
        // Enable auto detect button again
        document.getElementById('autoDetectBtn').disabled = false;
    }
    
    loadClasses() {
        const classList = document.getElementById('classList');
        classList.innerHTML = '';
        
        // Load only palm tree class
        this.classes = ['palm tree'];
        this.activeClass = 0;
        
        this.classes.forEach((className, index) => {
            const classButton = document.createElement('button');
            classButton.className = `action-btn ${index === this.activeClass ? '' : 'secondary'} w-100 mb-2`;
            classButton.textContent = className;
            classButton.onclick = () => this.setActiveClass(index);
            classList.appendChild(classButton);
        });
    }
    
    setActiveClass(index) {
        this.activeClass = index;
        this.loadClasses();
    }
    
    saveState() {
        this.undoStack.push(JSON.parse(JSON.stringify(this.annotations)));
        this.redoStack = [];
    }
    
    updateBoxCount() {
        document.getElementById('boxCount').textContent = this.annotations.length;
    }
    
    updateUI() {
        document.getElementById('currentImageIndex').textContent = this.currentImageIndex + 1;
        document.getElementById('totalImages').textContent = this.images.length;
        
        document.getElementById('prevBtn').disabled = this.currentImageIndex === 0;
        document.getElementById('nextBtn').disabled = this.currentImageIndex === this.images.length - 1;
    }
    
    updateDisplay() {
        // Update UI elements
        this.updateUI();
        this.updateBoxCount();
        
        // Redraw canvas if there's a current image
        if (this.currentImage) {
            this.drawImage();
            this.drawAnnotations();
        }
    }
    
    showBoxProperties(box) {
        const propertiesDiv = document.getElementById('boxProperties');
        propertiesDiv.innerHTML = `
            <div class="mb-3">
                <label class="form-label text-secondary">الفئة</label>
                <select class="form-select" onchange="annotationTool.updateBoxClass(${box.id}, this.value)" style="background: var(--bg-glass-hover); border: 1px solid var(--border-glass); color: var(--text-primary);">
                    ${this.classes.map((cls, idx) => 
                        `<option value="${idx}" ${idx === box.class ? 'selected' : ''}>${cls}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label text-secondary">الموضع</label>
                <div class="text-muted small">
                    X: ${Math.round(box.x)}, Y: ${Math.round(box.y)}<br>
                    W: ${Math.round(box.width)}, H: ${Math.round(box.height)}
                </div>
            </div>
            <button class="action-btn secondary w-100" onclick="annotationTool.deleteSelectedBox()">
                <i data-lucide="trash-2"></i>
                حذف الصندوق
            </button>
        `;
    }
    
    updateBoxClass(boxId, newClass) {
        const box = this.annotations.find(b => b.id === boxId);
        if (box) {
            this.saveState();
            box.class = parseInt(newClass);
            this.redraw();
        }
    }
    
    deleteSelectedBox() {
        if (this.selectedBox) {
            this.saveState();
            const index = this.annotations.indexOf(this.selectedBox);
            this.annotations.splice(index, 1);
            this.selectedBox = null;
            document.getElementById('boxProperties').innerHTML = '<p class="text-muted">حدد صندوق إحاطة لتحرير الخصائص</p>';
            this.updateBoxCount();
            this.redraw();
        }
    }
    
    loadAnnotationsForImage() {
        // Load saved annotations for current image
        const savedAnnotations = localStorage.getItem(`annotations_${this.currentImageIndex}`);
        this.annotations = savedAnnotations ? JSON.parse(savedAnnotations) : [];
        this.updateBoxCount();
    }
    
    saveAnnotations() {
        localStorage.setItem(`annotations_${this.currentImageIndex}`, JSON.stringify(this.annotations));
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show glass';
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        notification.innerHTML = `
            <i data-lucide="check-circle" class="me-2"></i>
            تم حفظ التصنيفات بنجاح
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    // ... existing methods for canvas handling, drawing, etc.
    initializeEventListeners() {
        // Canvas event listeners
        this.canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
        this.canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
        this.canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
        this.canvas.addEventListener('click', this.onCanvasClick.bind(this));
        
        // Initialize canvas size
        this.resizeCanvas();
    }
    
    resizeCanvas() {
        this.canvas.width = this.canvas.offsetWidth;
        this.canvas.height = this.canvas.offsetHeight;
        this.redraw();
    }
    
    onMouseDown(e) {
        if (this.tool === 'draw') {
            this.isDrawing = true;
            const rect = this.canvas.getBoundingClientRect();
            this.startX = (e.clientX - rect.left) / this.scale;
            this.startY = (e.clientY - rect.top) / this.scale;
        }
    }
    
    onMouseMove(e) {
        if (this.isDrawing && this.tool === 'draw') {
            this.redraw();
            const rect = this.canvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / this.scale;
            const currentY = (e.clientY - rect.top) / this.scale;
            
            // Draw preview rectangle
            this.ctx.strokeStyle = '#8B5CF6';
            this.ctx.lineWidth = 2;
            this.ctx.setLineDash([5, 5]);
            this.ctx.strokeRect(this.startX, this.startY, currentX - this.startX, currentY - this.startY);
            this.ctx.setLineDash([]);
        }
    }
    
    onMouseUp(e) {
        if (this.isDrawing && this.tool === 'draw') {
            this.isDrawing = false;
            const rect = this.canvas.getBoundingClientRect();
            const endX = (e.clientX - rect.left) / this.scale;
            const endY = (e.clientY - rect.top) / this.scale;
            
            // Create bounding box
            const x = Math.min(this.startX, endX);
            const y = Math.min(this.startY, endY);
            const width = Math.abs(endX - this.startX);
            const height = Math.abs(endY - this.startY);
            
            if (width > 10 && height > 10) {
                this.saveState();
                const box = {
                    id: Date.now(),
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                    class: this.activeClass
                };
                this.annotations.push(box);
                this.updateBoxCount();
                this.redraw();
            }
        }
    }
    
    onCanvasClick(e) {
        if (this.tool === 'select') {
            const rect = this.canvas.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) / this.scale;
            const clickY = (e.clientY - rect.top) / this.scale;
            
            // Find clicked box
            for (let i = this.annotations.length - 1; i >= 0; i--) {
                const box = this.annotations[i];
                if (clickX >= box.x && clickX <= box.x + box.width &&
                    clickY >= box.y && clickY <= box.y + box.height) {
                    this.selectedBox = box;
                    this.showBoxProperties(box);
                    this.redraw();
                    break;
                }
            }
        }
    }
    
    redraw() {
        if (!this.currentImage) return;
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Draw image
        this.ctx.drawImage(this.currentImage, 0, 0, this.canvas.width, this.canvas.height);
        
        // Draw annotations
        this.annotations.forEach((box, index) => {
            const isSelected = box === this.selectedBox;
            
            this.ctx.strokeStyle = isSelected ? '#EC4899' : '#8B5CF6';
            this.ctx.lineWidth = isSelected ? 3 : 2;
            this.ctx.strokeRect(box.x, box.y, box.width, box.height);
            
            // Draw label
            this.ctx.fillStyle = isSelected ? '#EC4899' : '#8B5CF6';
            this.ctx.fillRect(box.x, box.y - 20, 80, 20);
            this.ctx.fillStyle = '#FFFFFF';
            this.ctx.font = '12px Inter';
            this.ctx.fillText(this.classes[box.class], box.x + 5, box.y - 5);
        });
    }
    
    loadImage(file, index) {
        const reader = new FileReader();
        reader.onload = (e) => {
            this.currentImage = new Image();
            this.currentImage.onload = () => {
                this.currentImageIndex = index;
                this.loadAnnotationsForImage();
                this.resizeCanvas();
                this.updateUI();
            };
            this.currentImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// Global annotation tool instance
let annotationTool;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    try {
        annotationTool = new AnnotationTool();
        console.log('Annotation tool initialized successfully');
    } catch (error) {
        console.error('Error initializing annotation tool:', error);
    }
});

// Global functions for auto detection
function uploadImagesForAutoDetection() {
    console.log('uploadImagesForAutoDetection called');
    
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        alert('خطأ: لم يتم تهيئة أداة التصنيف. يرجى إعادة تحميل الصفحة.');
        return;
    }
    
    console.log('Annotation tool is initialized, creating file input');
    
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*,.zip';
    
    input.onchange = function(e) {
        console.log('File input change event triggered');
        const files = Array.from(e.target.files);
        console.log('Selected files:', files);
        
        if (files.length > 0) {
            // Check if any ZIP files are selected
            const zipFiles = files.filter(file => file.name.toLowerCase().endsWith('.zip'));
            const imageFiles = files.filter(file => 
                file.name.toLowerCase().endsWith('.jpg') || 
                file.name.toLowerCase().endsWith('.jpeg') || 
                file.name.toLowerCase().endsWith('.png') || 
                file.name.toLowerCase().endsWith('.bmp') ||
                file.name.toLowerCase().endsWith('.gif')
            );
            
            if (zipFiles.length > 0) {
                // Handle ZIP files
                handleZipFiles(zipFiles, (extractedFiles) => {
                    const allFiles = [...imageFiles, ...extractedFiles];
                    processSelectedFiles(allFiles);
                });
            } else {
                // Process image files directly
                processSelectedFiles(imageFiles);
            }
        } else {
            console.log('No files selected');
        }
    };
}

function processSelectedFiles(files) {
    if (files.length === 0) {
        showNotification('لم يتم العثور على ملفات صور صالحة', 'warning');
        return;
    }
    
    console.log('Processing selected files:', files);
    
    // Store files in annotationTool
    annotationTool.uploadedImages = files;
    console.log('Files stored in annotationTool:', annotationTool.uploadedImages);
    
    // Enable auto detect button
    const autoDetectBtn = document.getElementById('autoDetectBtn');
    if (autoDetectBtn) {
        autoDetectBtn.disabled = false;
        console.log('Auto detect button enabled');
    } else {
        console.error('Auto detect button not found');
    }
    
    // Show preview
    showUploadPreview(files);
    
    // Update UI to show selected files
    updateFileSelectionUI(files);
}

function handleZipFiles(zipFiles, callback) {
    console.log('Handling ZIP files:', zipFiles);
    
    // For now, we'll just show a message that ZIP support is coming
    // In a real implementation, you would extract the ZIP files here
    showNotification('دعم ملفات ZIP قيد التطوير. يرجى رفع الصور مباشرة.', 'info');
    
    // Call callback with empty array for now
    callback([]);
}
    
    // Trigger file selection
    input.click();
    console.log('File input clicked');
}

function updateFileSelectionUI(files) {
    // Create a visual indicator of selected files
    const fileListDiv = document.getElementById('selectedFilesList');
    if (!fileListDiv) {
        // Create the div if it doesn't exist
        const newFileListDiv = document.createElement('div');
        newFileListDiv.id = 'selectedFilesList';
        newFileListDiv.className = 'mt-3 p-3 glass';
        newFileListDiv.style.cssText = 'border-radius: 16px; background: var(--bg-glass-hover);';
        newFileListDiv.innerHTML = '<h6 class="text-secondary mb-2">الملفات المحددة:</h6>';
        
        // Insert after the upload section
        const uploadSection = document.querySelector('.mb-4');
        if (uploadSection) {
            uploadSection.parentNode.insertBefore(newFileListDiv, uploadSection.nextSibling);
        }
    }
    
    const fileListDiv = document.getElementById('selectedFilesList');
    if (fileListDiv) {
        let fileListHTML = '<h6 class="text-secondary mb-2">الملفات المحددة:</h6>';
        files.forEach((file, index) => {
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileListHTML += `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: var(--bg-glass); border-radius: 8px;">
                    <div>
                        <i data-lucide="image" class="me-2" style="color: var(--primary-purple);"></i>
                        <span class="text-secondary">${file.name}</span>
                    </div>
                    <small class="text-muted">${fileSize} MB</small>
                </div>
            `;
        });
        fileListHTML += `<small class="text-muted">تم تحديد ${files.length} ملف. اضغط "بدء الكشف والحفظ التلقائي" للمتابعة.</small>`;
        
        fileListDiv.innerHTML = fileListHTML;
        
        // Refresh Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
}

function showUploadPreview(files) {
    console.log('Showing upload preview for', files.length, 'files');
    
    // Show preview in a modal or alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show glass';
    alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
    alertDiv.innerHTML = `
        <i data-lucide="check-circle" class="me-2"></i>
        <strong>تم رفع ${files.length} ملف بنجاح!</strong>
        <br><small>اضغط "بدء الكشف والحفظ التلقائي" لبدء المعالجة.</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the page
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
    
    // Also show a success message in the main area
    showSuccessMessage(`تم رفع ${files.length} ملف بنجاح! يمكنك الآن الضغط على "بدء الكشف والحفظ التلقائي"`);
}

function showSuccessMessage(message) {
    // Remove any existing success message
    const existingMessage = document.getElementById('successMessage');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Create new success message
    const successDiv = document.createElement('div');
    successDiv.id = 'successMessage';
    successDiv.className = 'alert alert-success glass';
    successDiv.style.cssText = 'margin-top: 1rem; border-radius: 16px;';
    successDiv.innerHTML = `
        <i data-lucide="check-circle" class="me-2"></i>
        ${message}
    `;
    
    // Insert after the upload section
    const uploadSection = document.querySelector('.mb-4');
    if (uploadSection) {
        uploadSection.parentNode.insertBefore(successDiv, uploadSection.nextSibling);
    }
    
    // Refresh Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function startAutoDetection() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (annotationTool.uploadedImages.length === 0) {
        alert('يرجى رفع الصور أولاً!');
        return;
    }
    
    if (annotationTool.isAutoDetecting) {
        alert('الكشف التلقائي جاري بالفعل!');
        return;
    }
    
    // Start auto detection and save to dataset
    startAutoDetectionAndSave();
}

function startAutoDetectionAndSave() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    showNotification('جاري بدء الكشف التلقائي والحفظ...', 'info');
    
    // Disable button during processing
    const autoDetectBtn = document.getElementById('autoDetectBtn');
    autoDetectBtn.disabled = true;
    autoDetectBtn.innerHTML = '<i data-lucide="loader-2" class="spinning"></i> جاري المعالجة...';
    
    // Process all images and save to dataset
    processImagesAndSaveToDataset();
}

function processImagesAndSaveToDataset() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    const totalImages = annotationTool.uploadedImages.length;
    let processedCount = 0;
    let successfulCount = 0;
    let failedCount = 0;
    
    // Process each image
    annotationTool.uploadedImages.forEach((imageData, index) => {
        setTimeout(() => {
            // Start auto detection for this image
            annotationTool.startAutoDetectionForImage(imageData, (detections) => {
                // Save to dataset
                saveImageToDataset(imageData, detections, () => {
                    processedCount++;
                    if (processedCount === totalImages) {
                        // All images processed
                        const message = `تم معالجة ${totalImages} صور: ${successfulCount} نجح، ${failedCount} فشل`;
                        showNotification(message, successfulCount === totalImages ? 'success' : 'warning');
                        
                        // Re-enable button
                        const autoDetectBtn = document.getElementById('autoDetectBtn');
                        autoDetectBtn.disabled = false;
                        autoDetectBtn.innerHTML = '<i data-lucide="zap"></i> بدء الكشف والحفظ التلقائي';
                        
                        // Update display
                        annotationTool.updateDisplay();
                    }
                });
            });
        }, index * 200); // Process images with small delay
    });
}

function saveImageToDataset(imageData, detections, callback) {
    // Prepare data for saving
    const imageAnnotations = [{
        image_path: imageData.name, // Using name as path for now
        annotations: detections.map(det => ({
            class: 'palm_tree', // Default class
            x: det.x,
            y: det.y,
            width: det.width,
            height: det.height
        })),
        output_name: imageData.name.split('.')[0] // Remove extension
    }];
    
    // Send to backend for saving
    fetch('/api/annotations/save_batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            image_annotations: imageAnnotations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            successfulCount++;
            showNotification(`تم حفظ ${imageData.name} بنجاح`, 'success');
        } else {
            failedCount++;
            showNotification(`فشل في حفظ ${imageData.name}: ${data.message}`, 'error`);
        }
        callback();
    })
    .catch(error => {
        failedCount++;
        showNotification(`خطأ في حفظ ${imageData.name}: ${error.message}`, 'error');
        callback();
    });
}

function downloadAutoDetectionResults() {
    // Download results from augmented_data folder
    fetch('/api/download_auto_detection_results')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'palm_tree_detection_results.zip';
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error downloading results:', error);
            alert('خطأ في تحميل النتائج. يرجى التحقق من وحدة التحكم للتفاصيل.');
        });
}

// Tool functions
function setTool(tool) {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    annotationTool.tool = tool;
    
    // Update UI
    document.querySelectorAll('[id$="Tool"]').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tool + 'Tool').classList.add('active');
    
    // Update cursor
    const cursor = tool === 'draw' ? 'crosshair' : tool === 'select' ? 'pointer' : 'not-allowed';
    annotationTool.canvas.style.cursor = cursor;
}

function addClass() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    const input = document.getElementById('newClassName');
    const className = input.value.trim();
    
    if (className && className.toLowerCase() === 'palm tree') {
        // Only allow palm tree class
        if (!annotationTool.classes.includes(className)) {
            annotationTool.classes = [className];
            annotationTool.activeClass = 0;
            annotationTool.loadClasses();
        }
        input.value = 'palm tree';
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show glass';
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        notification.innerHTML = `
            <i data-lucide="check-circle" class="me-2"></i>
            تم إضافة الفئة "${className}" بنجاح
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    } else {
        alert('فقط فئة "palm tree" مسموح بها لهذا المشروع.');
        input.value = 'palm tree';
    }
}

function loadImages(files) {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    annotationTool.images = Array.from(files);
    
    if (files.length > 0) {
        annotationTool.loadImage(files[0], 0);
        
        // Update image list
        const imageList = document.getElementById('imageList');
        imageList.innerHTML = '';
        
        Array.from(files).forEach((file, index) => {
            const thumbnail = document.createElement('div');
            thumbnail.className = `p-2 mb-2 border rounded cursor-pointer ${index === 0 ? 'border-primary' : ''}`;
            thumbnail.style.cssText = 'cursor: pointer; border-color: var(--border-glass) !important;';
            thumbnail.innerHTML = `
                <img src="${URL.createObjectURL(file)}" class="img-fluid" style="max-height: 60px; border-radius: 8px;">
                <div class="small mt-1 text-center">${file.name}</div>
            `;
            thumbnail.onclick = () => selectImage(index);
            imageList.appendChild(thumbnail);
        });
    }
}

function selectImage(index) {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (index >= 0 && index < annotationTool.images.length) {
        // Save current annotations
        annotationTool.saveAnnotations();
        
        // Load new image
        annotationTool.loadImage(annotationTool.images[index], index);
        
        // Update thumbnail selection
        document.querySelectorAll('#imageList > div').forEach((thumb, i) => {
            thumb.className = thumb.className.replace('border-primary', '');
            if (i === index) {
                thumb.classList.add('border-primary');
            }
        });
    }
}

function previousImage() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (annotationTool.currentImageIndex > 0) {
        selectImage(annotationTool.currentImageIndex - 1);
    }
}

function nextImage() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (annotationTool.currentImageIndex < annotationTool.images.length - 1) {
        selectImage(annotationTool.currentImageIndex + 1);
    }
}

function undoLast() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (annotationTool.undoStack.length > 0) {
        annotationTool.redoStack.push(JSON.parse(JSON.stringify(annotationTool.annotations)));
        annotationTool.annotations = annotationTool.undoStack.pop();
        annotationTool.updateBoxCount();
        annotationTool.redraw();
    }
}

function redoLast() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (annotationTool.redoStack.length > 0) {
        annotationTool.undoStack.push(JSON.parse(JSON.stringify(annotationTool.annotations)));
        annotationTool.annotations = annotationTool.redoStack.pop();
        annotationTool.updateBoxCount();
        annotationTool.redraw();
    }
}

function clearAll() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    if (confirm('هل أنت متأكد من حذف جميع التصنيفات لهذه الصورة؟')) {
        annotationTool.saveState();
        annotationTool.annotations = [];
        annotationTool.selectedBox = null;
        annotationTool.updateBoxCount();
        annotationTool.redraw();
        document.getElementById('boxProperties').innerHTML = '<p class="text-muted">حدد صندوق إحاطة لتحرير الخصائص</p>';
    }
}

function saveAnnotations() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    annotationTool.saveAnnotations();
}

function zoomIn() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    annotationTool.scale = Math.min(annotationTool.scale * 1.2, 3);
    annotationTool.resizeCanvas();
    annotationTool.redraw();
}

function zoomOut() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    annotationTool.scale = Math.max(annotationTool.scale / 1.2, 0.1);
    annotationTool.resizeCanvas();
    annotationTool.redraw();
}

function resetZoom() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    annotationTool.scale = 1;
    annotationTool.resizeCanvas();
    annotationTool.redraw();
}

function exportYOLO() {
    if (!annotationTool) {
        console.error('Annotation tool not initialized');
        return;
    }
    
    // Export annotations in YOLO format
    const data = {
        images: annotationTool.images.map(img => img.name),
        annotations: {},
        classes: annotationTool.classes
    };
    
    // Collect all annotations
    for (let i = 0; i < annotationTool.images.length; i++) {
        const savedAnnotations = localStorage.getItem(`annotations_${i}`);
        if (savedAnnotations) {
            data.annotations[annotationTool.images[i].name] = JSON.parse(savedAnnotations);
        }
    }
    
    // Send to server for processing
    fetch('/api/export_annotations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'yolo_annotations.zip';
        a.click();
        window.URL.revokeObjectURL(url);
    });
}

function exportCOCO() {
    // Show info notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show glass';
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
    notification.innerHTML = `
        <i data-lucide="info" class="me-2"></i>
        ميزة تصدير COCO قادمة قريباً
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function generateDataset() {
    // Show info notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show glass';
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
    notification.innerHTML = `
        <i data-lucide="info" class="me-2"></i>
        ميزة إنشاء Dataset قادمة قريباً
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Dataset Management Functions
function saveToDataset() {
    if (!annotationTool || !annotationTool.images || annotationTool.images.length === 0) {
        showNotification('لا توجد صور للحفظ', 'warning');
        return;
    }
    
    // Collect all annotations
    const imageAnnotations = [];
    let hasAnnotations = false;
    
    for (let i = 0; i < annotationTool.images.length; i++) {
        const savedAnnotations = localStorage.getItem(`annotations_${i}`);
        if (savedAnnotations) {
            const annotations = JSON.parse(savedAnnotations);
            if (annotations && annotations.length > 0) {
                hasAnnotations = true;
                imageAnnotations.push({
                    image_path: annotationTool.images[i].path,
                    annotations: annotations,
                    output_name: annotationTool.images[i].name.replace(/\.[^/.]+$/, "") // Remove extension
                });
            }
        }
    }
    
    if (!hasAnnotations) {
        showNotification('لا توجد تصنيفات للحفظ', 'warning');
        return;
    }
    
    // Show progress
    showNotification('جاري حفظ التصنيفات في Dataset...', 'info');
    
    // Save to dataset
    fetch('/api/annotations/save_batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image_annotations: imageAnnotations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`تم حفظ ${data.successful} صورة بنجاح في Dataset`, 'success');
            // Refresh dataset info
            getDatasetInfo();
        } else {
            showNotification(`فشل في حفظ ${data.failed} صورة`, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving to dataset:', error);
        showNotification('خطأ في حفظ التصنيفات', 'error');
    });
}

function getDatasetInfo() {
    fetch('/api/dataset/info')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification('خطأ في جلب معلومات Dataset', 'error');
                return;
            }
            
            // Create and show dataset info modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'datasetInfoModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content glass">
                        <div class="modal-header">
                            <h5 class="modal-title">معلومات Dataset</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>صور التدريب</h6>
                                    <p class="h4 text-primary">${data.train_images}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>ملفات التصنيف</h6>
                                    <p class="h4 text-success">${data.train_labels}</p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>صور التحقق</h6>
                                    <p class="h4 text-warning">${data.val_images}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>عدد الفئات</h6>
                                    <p class="h4 text-info">${data.class_count}</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>الفئات:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${data.classes.map(cls => `<span class="badge bg-primary">${cls}</span>`).join('')}
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>مسار Dataset:</h6>
                                <code class="text-muted">${data.base_path}</code>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Clean up modal after it's hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error getting dataset info:', error);
            showNotification('خطأ في جلب معلومات Dataset', 'error');
        });
}

function validateDataset() {
    showNotification('جاري التحقق من Dataset...', 'info');
    
    fetch('/api/dataset/validate')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification('خطأ في التحقق من Dataset', 'error');
                return;
            }
            
            if (data.valid) {
                showNotification('Dataset صالح تماماً!', 'success');
            } else {
                showNotification(`Dataset يحتوي على ${data.issue_count} مشكلة`, 'warning');
                
                // Show issues in modal
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'validationModal';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content glass">
                            <div class="modal-header">
                                <h5 class="modal-title">نتائج التحقق من Dataset</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i data-lucide="alert-triangle" class="me-2"></i>
                                    تم العثور على ${data.issue_count} مشكلة في Dataset
                                </div>
                                <h6>المشاكل:</h6>
                                <ul class="list-group">
                                    ${data.issues.map(issue => `<li class="list-group-item text-danger">${issue}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-warning" onclick="cleanupDataset()">تنظيف Dataset</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // Clean up modal after it's hidden
                modal.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modal);
                });
            }
        })
        .catch(error => {
            console.error('Error validating dataset:', error);
            showNotification('خطأ في التحقق من Dataset', 'error');
        });
}

function cleanupDataset() {
    if (!confirm('هل أنت متأكد من تنظيف Dataset؟ سيتم حذف الملفات المفقودة.')) {
        return;
    }
    
    showNotification('جاري تنظيف Dataset...', 'info');
    
    fetch('/api/dataset/cleanup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            // Refresh dataset info
            getDatasetInfo();
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error cleaning up dataset:', error);
        showNotification('خطأ في تنظيف Dataset', 'error');
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show glass`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i data-lucide="${type === 'success' ? 'check-circle' : type === 'warning' ? 'alert-triangle' : type === 'error' ? 'x-circle' : 'info'}" class="me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Initialize Lucide icons for this page
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
});
</script>

<style>
.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}